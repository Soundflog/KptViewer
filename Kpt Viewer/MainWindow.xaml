<Window x:Class="Kpt_Viewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Kpt_Viewer"
        xmlns:viewModels="clr-namespace:Kpt_Viewer.ViewModels"
        mc:Ignorable="d"
        Title="KPT Viewer" Height="800" Width="1200"
        AllowDrop="True" DragOver="OnDragOver" Drop="OnDrop"
        >
    <Window.DataContext>
        <viewModels:MainViewModel />
    </Window.DataContext>


    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Open XML..." Command="{Binding OpenFileCommand}" />
                <Separator />
                <MenuItem Header="_Save selected..." Command="{Binding SaveSelectedCommand}" />
                <Separator />
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}" />
            </MenuItem>
            <MenuItem Header="_Help" Command="{Binding ShowHelpCommand}" />
        </Menu>


        <ToolBar DockPanel.Dock="Top">
            <Button Content="Open" Command="{Binding OpenFileCommand}" />
            <Button Content="Save selected" Command="{Binding SaveSelectedCommand}" />
            <Separator />
            <Button Content="Help" Command="{Binding ShowHelpCommand}" />
        </ToolBar>
        
        <!-- Search bar -->
        <ToolBar DockPanel.Dock="Top">
            <TextBlock Text="ID:" Margin="0,0,6,0" VerticalAlignment="Center"/>
            <TextBox Width="220"
                     Text="{Binding SearchId, UpdateSourceTrigger=PropertyChanged}"
                     ToolTip="Введите часть ID: cad_number / sk_id / reg_numb_border"/>
            <TextBlock Text="Адрес:" Margin="12,0,6,0" VerticalAlignment="Center"/>
            <TextBox Width="320"
                     Text="{Binding SearchAddress, UpdateSourceTrigger=PropertyChanged}"
                     ToolTip="Введите часть адреса (readable_address)"/>
            <Button Content="Очистить" Command="{Binding ClearSearchCommand}" Margin="6,0,0,0"/>
        </ToolBar>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="5*" />
            </Grid.ColumnDefinitions>


            <!-- Left: Tree -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                <TreeView ItemsSource="{Binding Roots}" SelectedItemChanged="TreeView_SelectedItemChanged">
                    <TreeView.Resources>
                        <!-- Root nodes -->
                        <HierarchicalDataTemplate DataType="{x:Type viewModels:RootNodeVm}"
                                                  ItemsSource="{Binding Children}">
                            <TextBlock Text="{Binding Header, Mode=OneWay}" />
                        </HierarchicalDataTemplate>
                        <!-- Item nodes (with checkbox) -->
                        <DataTemplate DataType="{x:Type viewModels:ItemNodeVm}">
                            <StackPanel Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" VerticalAlignment="Center"
                                          Margin="0,0,6,0" />
                                <TextBlock Text="{Binding Header}" />
                            </StackPanel>
                        </DataTemplate>
                    </TreeView.Resources>
                </TreeView>
            </ScrollViewer>


            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Width="5" />

            <!-- Right: Details -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>


                <TextBlock Margin="6" FontWeight="Bold">
                    <Run Text="Selected: " />
                    <!-- было: <Run Text="{Binding SelectedHeader}" /> -->
                    <Run Text="{Binding SelectedHeader, Mode=OneWay}" />
                </TextBlock>


                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>


                    <TextBox Grid.Row="0" 
                             Margin="6" 
                             Text="{Binding SelectedXmlPretty, Mode=OneWay}"
                             FontFamily="Consolas"
                             FontSize="12"
                             TextWrapping="NoWrap" 
                             HorizontalScrollBarVisibility="Auto"
                             VerticalScrollBarVisibility="Auto" 
                             AcceptsReturn="True" />


                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="6">
                        <Button Content="Copy XML" Command="{Binding CopyXmlCommand}" Margin="0,0,6,0" />
                        <Button Content="Save selected" Command="{Binding SaveSelectedCommand}" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </DockPanel>
</Window>